  <div class="row">



    <!---------------------- Einstellungen ---------------------->
    
  <div class="col-sm-4 bg-light rounded"><!-- col-sm-3 stacks until the sm breakpoint is reached -->
  <!-- see https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/range#adding_tick_marks -->


    <ul class="list-unstyled ps-0">
      <li class="mb-1">
        <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0" data-bs-toggle="collapse" data-bs-target="#annahmen-collapse" aria-expanded="true">
          Grundannahmen
        </button>
        <div class="collapse show" id="annahmen-collapse">
          <form id="Grundannahmen" method="get"> <!-- use form for easy reset button -->
            <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
              <li>
                <label for="regular_deficit" data-toggle="tooltip" title="Annahme: wird voll ausgeschöpft" data-placement="top">
                  reguläres Defizit:
                </label>
                <output id="regular_deficit.output" for="regular_deficit">0.00%</output> des BIP<br/>
                <input type="range" id="regular_deficit" name="regular_deficit" list="regular_deficit.markers" 
                  min="0" max="1" step="0.05" value="0" style="width: 100%;" 
                  oninput="document.getElementById('regular_deficit.output').value = parseFloat(this.value).toFixed(2)+'%'"/>
                <datalist id="regular_deficit.markers">
                  <option value="0.00" label="0%"></option>
                  <option value="0.25"></option>
                  <option value="0.50"></option>
                  <option value="0.75"></option>
                  <option value="1.00" label="1%"></option>
                </datalist>
              </li>
              <li>
                <label for="mean_growth" data-toggle="tooltip" title="reales Wachstum + Inflation" data-placement="top">
                  nominales Wachstum
                </label>
                <output id="mean_growth.output" for="mean_growth">2.8</output>%<br/>
                <input type="range" id="mean_growth" name="mean_growth" list="mean_growth.markers" min="0" max="5" step="0.1" value="2.8" style="width: 100%;" oninput="document.getElementById('mean_growth.output').value = parseFloat(this.value).toFixed(1)"/>
                <datalist id="mean_growth.markers">
                  <option value="0" label="0%"></option>
                  <option value="1"></option>
                  <option value="2"></option>
                  <option value="3"></option>
                  <option value="4"></option>
                  <option value="5" label="5%"></option>
                </datalist>
              </li>
              <li>
                <label for="r_bar" data-toggle="tooltip" title="langfr. Mittelwert" data-placement="top">
                  Nominalzins
                </label>
                <output id="r_bar.output" for="r_bar">3.0</output>%<br/>
                <input type="range" id="r_bar" name="r_bar" list="r_bar.markers" min="0" max="5" step="0.1" value="3" style="width: 100%;" oninput="document.getElementById('r_bar.output').value = parseFloat(this.value).toFixed(1)"/>
                <datalist id="r_bar.markers">
                  <option value="0" label="0%"></option>
                  <option value="1"></option>
                  <option value="2"></option>
                  <option value="3"></option>
                  <option value="4"></option>
                  <option value="5" label="5%"></option>
                </datalist>
              </li>
            </ul>
          </form>
        </div>
      </li>
      <li class="mb-1">
        <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-toggle="collapse" data-bs-target="#notkredit-collapse" aria-expanded="false">
          Notkredit
        </button>
        <div class="collapse" id="notkredit-collapse">
          <form id="Notkredit" method="get"> <!-- use form for easy reset button -->
            <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
              <li>
                <label for="excess_time" data-toggle="tooltip" title="mittlere Häufigkeit" data-placement="top">
                  Häufigkeit alle
                </label>
                <output id="excess_time.output" for="excess_time">5</output> Jahre<br/>
                <input type="range" id="excess_time" name="excess_time" list="excess_time.markers" min="1" max="20" step="1" value="5" style="width: 100%;" oninput="document.getElementById('excess_time.output').value = this.value"/>
                <datalist id="excess_time.markers">
                  <option value="1" label="1"></option>
                  <option value="5"></option>
                  <option value="10"></option>
                  <option value="15"></option>
                  <option value="20" label="20"></option>
                </datalist>
              </li>
              <li>
                <label for="excess_deficit_mean" data-toggle="tooltip" title="lognormal-verteilt" data-placement="top">
                  mittlerer Notkredit:
                </label>
                <output id="excess_deficit_mean.output" for="excess_deficit_mean">1.0</output>% des BIP<br/>
                <input type="range" id="excess_deficit_mean" name="excess_deficit_mean" list="excess_deficit_mean.markers" min="0" max="5" step="0.1" value="1" style="width: 100%;" oninput="document.getElementById('excess_deficit_mean.output').value = parseFloat(this.value).toFixed(1)"/>
                <datalist id="excess_deficit_mean.markers">
                  <option value="0" label="0%"></option>
                  <option value="1"></option>
                  <option value="2"></option>
                  <option value="3"></option>
                  <option value="4"></option>
                  <option value="5" label="5%"></option>
                </datalist>
              </li>
              <li>
                <label for="excess_amort" data-toggle="tooltip" title="Annahme: lineare Tilgung" data-placement="top">
                  Tilgungsdauer
                </label>
                <output id="excess_amort.output" for="excess_amort">40</output> Jahre<br/>
                <input type="range" id="excess_amort" name="excess_amort" list="excess_amort.markers" min="1" max="100" step="1" value="40" style="width: 100%;" oninput="document.getElementById('excess_amort.output').value = this.value"/>
                <datalist id="excess_amort.markers">
                  <option value="1" label="1"></option>
                  <option value="25"></option>
                  <option value="50"></option>
                  <option value="75"></option>
                  <option value="100" label="100"></option>
                </datalist>
              </li>
            </ul>
          </form>
        </div>
      </li>
      <!--<li class="border-top my-3"></li>-->
      <li class="mb-1">
        <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-toggle="collapse" data-bs-target="#einstellungen-collapse" aria-expanded="false">
          Einstellungen
        </button>
        <div class="collapse" id="einstellungen-collapse">
          <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
              <li>
                <label for="TT">Simulationshorizont</label>
                <output id="TT.output" for="TT">36</output> Jahre<br/>
                <input type="range" id="TT" name="TT" list="TT.markers" min="10" max="200" step="1" value="36" style="width: 100%;" oninput="document.getElementById('TT.output').value = this.value"/>
                <datalist id="TT.markers">
                  <option value="1" label="1"></option>
                  <option value="50"></option>
                  <option value="100"></option>
                  <option value="150"></option>
                  <option value="200" label="200"></option>
                </datalist>
              </li>
              <li>
                <label for="n_sim">Anzahl Simulationsrunden:</label>
                <output id="n_sim.output" for="n_sim">250</output><br/>
                <input type="range" id="n_sim" name="n_sim" list="n_sim.markers" min="100" max="1000" step="50" value="250" style="width: 100%;" oninput="document.getElementById('n_sim.output').value = this.value"/>
                <datalist id="n_sim.markers">
                  <option value="100" label="100"></option>
                  <option value="250"></option>
                  <option value="500"></option>
                  <option value="750"></option>
                  <option value="1000" label="1000"></option>
                </datalist>
              </li>
          </ul>
        </div>
      </li>
    </ul>
  </div> <!-- end column -->
  
  <div class="col-sm-8 bg-light">
    <span id="test_output"></span>
    <!--<canvas id="simulation-chart" width="399" height="199" style="display: block; box-sizing: border-box; height: 199px; width: 399px;"></canvas>-->
    <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-toggle="collapse" data-bs-target="#Grafik-Schuldenquote" aria-expanded="true">
      Ergebnis: Schuldenquote
    </button><br>
    <div class="chart-container collapse show" id="Grafik-Schuldenquote">
      <div id="graphdiv1" class="chart"></div>
      <div id="graphlabel1" class="chart-label"></div>
    </div>
    <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-toggle="collapse" data-bs-target="#Grafik-ZinsSteuerQuote" aria-expanded="true">
      Ergebnis: Zins-Steuer-Quote
    </button><br>
    <div class="chart-container collapse show" id="Grafik-ZinsSteuerQuote">
      <div id="graphdiv2" class="chart"></div><br>
      <div id="graphlabel2" class="chart-label"></div>
    </div>
    
    
    
    
    
    <script src="./MonteCarloSim.js"></script><!-- removed type="module" -->
    <script src="./Daten.js"></script>
    <script>
      //import {oneSim, longRunSS} from './MonteCarloSim.js';
      const out = document.getElementById('test_output');
      //let chart;
      let res; // Monte Carlo result      

      // collect parameters in a single object
      const parms = {};
      parms.regular_deficit = document.getElementById("regular_deficit");
      parms.mean_growth = document.getElementById("mean_growth");
      parms.excess_time = document.getElementById("excess_time");
      parms.r_bar = document.getElementById("r_bar");
      parms.excess_deficit_mean = document.getElementById("excess_deficit_mean");
      parms.excess_amort = document.getElementById("excess_amort");
      parms.TT = document.getElementById("TT");
      parms.n_sim = document.getElementById("n_sim");

      function printParms() {
        for (const i in parms) {
          console.log(`${i}: ${parms[i].value}`)
        }
      }
      
      function updateLRSS() {
        //console.log("Hello from updateLRSS()!")
        let x_prob = 1/parms.excess_time.value;
        let lrss = longRunSS(parms.mean_growth.value, 
          parms.regular_deficit.value, 
          x_prob, 
          parms.excess_deficit_mean.value, 
          parms.excess_amort.value);
        out.innerHTML = `Long run steady state: ${lrss.toFixed(1)}%<br>`;
      }

      function updateSimulation() {
        //console.log("Hello from updateSimulation()!")
        let x_prob = 1/parms.excess_time.value;
        // compute MC sim
        res = MCsim(
          b0, parms.mean_growth.value, g_sd, g_se, parms.regular_deficit.value,
          x_prob, parms.excess_deficit_mean.value, x_sd, parms.excess_amort.value,
          i0, r0, parms.r_bar.value, LZ, tyr,
          parms.TT.value, parms.n_sim.value
        );
        // compute LRSS
        res.Schuldenquote.lrss = longRunSS(parms.mean_growth.value, 
          parms.regular_deficit.value, 
          x_prob, 
          parms.excess_deficit_mean.value, 
          parms.excess_amort.value);
        res.ZinsSteuerQuote.lrss = res.Schuldenquote.lrss*parms.r_bar.value/(tyr*(1+parms.mean_growth.value/100));
        
        renderChart(res);
      }

      function renderChart(dta) {

        // parse data in a format that is digestible by dygraph
        var TT = maxArray(dta.Schuldenquote.time);

        // Schuldenquoten-Daten
        var plotdat1 = Array(nobs+TT);
        // fill historical data
        for (let i=0; i<nobs; i++) {
          plotdat1[i] = [histdata.Jahr[i], 
                        [null, histdata.Schuldenquote[i], null], // historische Schuldenquote
                        [null, null, null], // Platzhalter für Median
                        [null, null, null] // Platzhalter für long run steady state
                       ]
        }
        // fill simulated future data        
        for (let i=0; i<TT; i++) {
          plotdat1[i+nobs] = [
            dta.Schuldenquote.time[i]+T0, 
            [null, null, null],
            [dta.Schuldenquote.p05[i], dta.Schuldenquote.median[i], dta.Schuldenquote.p95[i]],
            [null, dta.Schuldenquote.lrss, null]
          ]
        }
        // berechne bounds der Grafiken
        var bt_min = Math.min(
          Math.min(...histdata.Schuldenquote),
          Math.min(...dta.Schuldenquote.p05)
        );
        bt_min = 5*Math.floor(bt_min/5); // round to lower multiple of 5
        var bt_max = Math.max(
          Math.max(...histdata.Schuldenquote),
          Math.max(...dta.Schuldenquote.p95)
        );
        bt_max = 5*Math.ceil(bt_max/5);
        
        var plotdat2 = Array(nobs+TT);
        // fill historical data
        for (let i=0; i<nobs; i++) {
          plotdat2[i] = [
            histdata.Jahr[i], 
            [null, histdata.ZinsSteuerQuote[i], null],
            [null, null, null], // Platzhalter für Median
            [null, null, null] // Platzhalter für long run steady state
          ]
        }
        for (let i=0; i<TT; i++) {
          plotdat2[i+nobs] = [
            dta.ZinsSteuerQuote.time[i]+T0, 
            [null, null, null],
            [dta.ZinsSteuerQuote.p05[i], dta.ZinsSteuerQuote.median[i], dta.ZinsSteuerQuote.p95[i]],
            [null, dta.ZinsSteuerQuote.lrss, null]
          ]
        }
        // berechne bounds der Grafiken
        var zsq_max = Math.max(
          Math.max(...histdata.ZinsSteuerQuote),
          Math.max(...dta.ZinsSteuerQuote.p95)
        );
        zsq_max = 5*Math.ceil(zsq_max/5);
        
        g1 = new Dygraph(
          
          // containing div
          document.getElementById("graphdiv1"),
          
          // native array format
          plotdat1,
          
          // options
          {
            labels: [ "Zeit", "historisch", "Median", "langfr. Gleichgewicht"],
            labelsDiv: "graphlabel1",
            hideOverlayOnMouseOut: true,
            legend: "always",
            customBars: true,
            interactionModel: {}, // prevent zoom an pan
            series: {
              'historisch': {
                strokeWidth: 1.5,
                drawPoints: false,
                color: "rgb(0,128,0)",
              },
              'Median': {
                strokeWidth: 1.5,
                strokePattern: [2,5],
                drawPoints: false,
                color: "rgb(0,128,0)",
              },
              'langfr. Gleichgewicht': {
                strokeWidth: 1.0,
                strokePattern: [5,2],
                drawPoints: false,
                color: "rgb(0,128,0)",
              }
            },
            axes: {
              x: {
                drawAxis: true,
                drawGrid: false,
                valueFormatter: function(y) {return y.toFixed(0)},
                axisLabelFormatter: function(y) {return y.toFixed(0)},
              },
              y: {
                drawGrid: true,
                valueRange: [0, bt_max],
                valueFormatter: function(y) {return y.toFixed(1)},
                axisLabelFormatter: function(y) {return y.toFixed(0)},
              }
            },
            //title: "Schuldenquote [% des BIP]",
            //titleHeight: 25,
          }
        );

        g2 = new Dygraph(
          
          // containing div
          document.getElementById("graphdiv2"),
          
          // native array format
          plotdat2,
          
          // options
          {
            labels: [ "Zeit", "historisch", "Median", "langfr. Gleichgewicht"],
            labelsDiv: "graphlabel2",
            //hideOverlayOnMouseOut: true,
            legend: "always",
            customBars: true,
            interactionModel: {}, // prevent zoom an pan
            series: {
              'historisch': {
                strokeWidth: 1.5,
                color: "rgb(0,0,128)",
              },
              'Median': {
                strokeWidth: 1.5,
                strokePattern: [2,5],
                color: "rgb(0,0,128)",
              },
              'langfr. Gleichgewicht': {
                strokeWidth: 1.0,
                strokePattern: [5,2],
                color: "rgb(0,0,128)",
              }
            },
            axes: {
              x: {
                drawAxis: true,
                drawGrid: false,
                valueFormatter: function(y) {return y.toFixed(0)},
                axisLabelFormatter: function(y) {return y.toFixed(0)},
              },
              y: {
                drawGrid: true,
                valueRange: [0,zsq_max],
                valueFormatter: function(y) {return y.toFixed(1)},
                axisLabelFormatter: function(y) {return y.toFixed(0)},
              }
            },
            //title: "Zins-Steuer-Quote",
            //titleHeight: 25,
          }
        );

        // synchronize the charts
        var sync = Dygraph.synchronize(g1, g2);
      }
      
      //window.onload = function() {
        updateSimulation();
        for (const i in parms) { // for .. in iterates over elements of an object
          //parms[i].addEventListener('input', updateLRSS);
          parms[i].addEventListener('change', updateSimulation); // use change instead, possible reason for crash on ios after active slider usage
        }
      //}

      window.onresize = function() {
        renderChart(res);
      };
    </script>
    
  </div> <!-- end columns -->

  </div> <!-- end row -->
